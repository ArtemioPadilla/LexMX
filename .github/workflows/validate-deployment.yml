name: ğŸš€ Deployment Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-typecheck:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run ESLint
        run: npm run lint

      - name: ğŸ” Run TypeScript check
        run: npm run type-check

  test-development:
    name: ğŸ§ª Development Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run development tests
        run: |
          chmod +x scripts/test-local-dev.js
          node scripts/test-local-dev.js
        timeout-minutes: 5

  build-and-validate:
    name: ğŸ—ï¸ Build & Validate
    runs-on: ubuntu-latest
    needs: test-development
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build static site
        run: npm run build
        env:
          # Set base URL for GitHub Pages
          PUBLIC_BASE_URL: /LexMX

      - name: ğŸš€ Validate deployment readiness
        run: |
          chmod +x scripts/validate-deployment.js
          node scripts/validate-deployment.js

      - name: ğŸ“Š Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 1

      - name: ğŸ“‹ Validate specific files exist
        run: |
          echo "Checking critical files..."
          test -f dist/index.html || (echo "âŒ index.html missing" && exit 1)
          test -f dist/manifest.json || (echo "âŒ manifest.json missing" && exit 1)
          test -f dist/sw.js || (echo "âŒ sw.js missing" && exit 1)
          test -f dist/legal-corpus/metadata.json || (echo "âŒ corpus metadata missing" && exit 1)
          test -f dist/embeddings/embeddings-metadata.json || (echo "âŒ embeddings metadata missing" && exit 1)
          echo "âœ… All critical files present"

  test-build-output:
    name: ğŸ” Test Build Output
    runs-on: ubuntu-latest
    needs: build-and-validate
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: dist/

      - name: ğŸ” Analyze build size
        run: |
          echo "ğŸ“Š Build size analysis:"
          du -sh dist/
          echo ""
          echo "ğŸ“ Largest files:"
          find dist/ -type f -exec du -h {} + | sort -hr | head -10
          echo ""
          echo "ğŸ“ˆ File count by type:"
          find dist/ -name "*.html" | wc -l | xargs -I {} echo "HTML files: {}"
          find dist/ -name "*.js" | wc -l | xargs -I {} echo "JavaScript files: {}"
          find dist/ -name "*.css" | wc -l | xargs -I {} echo "CSS files: {}"
          find dist/ -name "*.json" | wc -l | xargs -I {} echo "JSON files: {}"

      - name: ğŸ” Check for hardcoded URLs
        run: |
          echo "Checking for hardcoded localhost URLs..."
          if grep -r "localhost" dist/ --exclude-dir=node_modules; then
            echo "âŒ Found hardcoded localhost URLs"
            exit 1
          fi
          
          echo "Checking for hardcoded development URLs..."
          if grep -r "127.0.0.1" dist/ --exclude-dir=node_modules; then
            echo "âŒ Found hardcoded development URLs"
            exit 1
          fi
          
          echo "âœ… No hardcoded development URLs found"

      - name: ğŸ” Validate HTML structure
        run: |
          echo "Validating HTML structure..."
          for html_file in $(find dist/ -name "*.html"); do
            if ! grep -q "<!DOCTYPE html>" "$html_file"; then
              echo "âŒ Missing DOCTYPE in $html_file"
              exit 1
            fi
            if ! grep -q "<title>" "$html_file"; then
              echo "âŒ Missing title in $html_file"
              exit 1
            fi
          done
          echo "âœ… All HTML files have valid structure"

      - name: ğŸ” Check JSON validity
        run: |
          echo "Validating JSON files..."
          for json_file in $(find dist/ -name "*.json"); do
            if ! python -m json.tool "$json_file" > /dev/null 2>&1; then
              echo "âŒ Invalid JSON in $json_file"
              exit 1
            fi
          done
          echo "âœ… All JSON files are valid"

  deploy-preview:
    name: ğŸš€ Deploy Preview
    runs-on: ubuntu-latest
    needs: test-build-output
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: dist/

      - name: ğŸš€ Deploy to GitHub Pages (Preview)
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸš€ Would deploy preview to GitHub Pages"
          echo "ğŸ“ Build size: $(du -sh dist/ | cut -f1)"
          echo "ğŸ“Š Files ready for deployment: $(find dist/ -type f | wc -l)"

  production-deployment:
    name: ğŸŒŸ Production Deployment
    runs-on: ubuntu-latest
    needs: test-build-output
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for production
        run: npm run build
        env:
          PUBLIC_BASE_URL: /LexMX

      - name: ğŸš€ Final validation
        run: |
          chmod +x scripts/validate-deployment.js
          node scripts/validate-deployment.js

      - name: âš™ï¸ Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: ğŸ“¤ Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‰ Deployment complete
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“Š Build completed at: $(date)"

  post-deploy-validation:
    name: âœ… Post-Deploy Validation
    runs-on: ubuntu-latest
    needs: production-deployment
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: â° Wait for deployment
        run: sleep 30

      - name: ğŸ” Validate live site
        run: |
          echo "ğŸ” Validating live deployment..."
          SITE_URL="https://artemiopadilla.github.io/LexMX"
          
          # Test home page
          if curl -f -s "$SITE_URL/" > /dev/null; then
            echo "âœ… Home page accessible"
          else
            echo "âŒ Home page not accessible"
            exit 1
          fi
          
          # Test key pages
          for path in "/chat" "/admin/documents" "/admin/embeddings"; do
            if curl -f -s "$SITE_URL$path" > /dev/null; then
              echo "âœ… $path accessible"
            else
              echo "âŒ $path not accessible"
              exit 1
            fi
          done
          
          # Test static assets
          for asset in "/manifest.json" "/favicon.svg"; do
            if curl -f -s "$SITE_URL$asset" > /dev/null; then
              echo "âœ… $asset accessible"
            else
              echo "âŒ $asset not accessible"
              exit 1
            fi
          done
          
          echo "ğŸ‰ All post-deployment validations passed!"